<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ASG Activity Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ‚úÖ Official AWS SDK (Fixed version, always available) -->
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1491.0.min.js"></script>

  <style>
    /* Loader animation */
    .loader {
      border-top-color: #3498db;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Fade animation for new data */
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Full-page loading overlay */
    #loading-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 50;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.25rem;
      flex-direction: column;
    }

    /* Smooth transition for button states */
    button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
  </style>
</head>

<body class="h-full text-gray-200">

  <!-- Overlay shown while data is loading -->
  <div id="loading-overlay" class="flex">
    <div class="loader border-4 border-t-4 border-gray-200 rounded-full h-12 w-12 mb-4"></div>
    <p id="loading-text">Fetching latest scaling data from AWS Auto Scaling...</p>
  </div>

  <div class="container mx-auto p-4 md:p-8 max-w-5xl">
    <h1 class="text-3xl font-bold mb-6 text-white text-center">
      ASG Activity Dashboard (Live)
    </h1>

    <!-- Info section -->
    <div class="text-center mb-6">
      <p class="text-lg">
        Viewing activity for:
        <strong id="asg-name" class="text-blue-400">Loading...</strong>
      </p>
      <p class="text-sm text-gray-400">
        Region: <span id="asg-region">Loading...</span>
      </p>
    </div>

    <!-- Refresh Button -->
    <div class="flex justify-center mb-6">
      <button
        id="refreshButton"
        class="w-1/2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 flex items-center justify-center"
      >
        <span id="button-text">üîÑ Refresh Data</span>
        <div
          id="loader"
          class="loader hidden ml-3 border-4 border-t-4 border-gray-200 rounded-full h-6 w-6"
        ></div>
      </button>
    </div>

    <!-- Table Container -->
    <div id="table-container" class="bg-gray-800 p-6 rounded-lg shadow-lg">
      <h2 class="text-xl font-semibold mb-4 text-white">Scaling Activity</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-700">
          <thead class="bg-gray-700">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Time</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Description</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Cause</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Status</th>
            </tr>
          </thead>
          <tbody
            id="activity-table-body"
            class="bg-gray-800 divide-y divide-gray-700 text-center text-gray-400"
          >
            <tr>
              <td colspan="4" class="px-6 py-4 text-sm">
                Click <strong>Refresh Data</strong> to load scaling activity.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <!-- Last updated text -->
      <p id="last-updated" class="text-sm text-gray-400 mt-4 text-right hidden"></p>
    </div>
  </div>

  <script>
    // --- Variables replaced by Terraform ---
    const COGNITO_IDENTITY_POOL_ID = "__COGNITO_POOL_ID__";
    const AWS_REGION = "__AWS_REGION__";
    const ASG_NAME = "__ASG_NAME__";

    // Display ASG info
    document.getElementById("asg-name").textContent = ASG_NAME;
    document.getElementById("asg-region").textContent = AWS_REGION;

    // Configure AWS SDK
    AWS.config.update({ region: AWS_REGION });
    AWS.config.credentials = new AWS.CognitoIdentityCredentials({
      IdentityPoolId: COGNITO_IDENTITY_POOL_ID,
    });

    const autoscaling = new AWS.AutoScaling();
    const refreshButton = document.getElementById("refreshButton");
    const buttonText = document.getElementById("button-text");
    const loader = document.getElementById("loader");
    const overlay = document.getElementById("loading-overlay");
    const tableBody = document.getElementById("activity-table-body");
    const lastUpdated = document.getElementById("last-updated");

    async function fetchActivity() {
      // --- Show loading feedback immediately ---
      overlay.style.display = "flex";
      loader.classList.remove("hidden");
      buttonText.textContent = "Refreshing...";
      refreshButton.disabled = true;

      try {
        console.log("üîÅ Fetching ASG data...");

        // Refresh Cognito credentials
        await new Promise((resolve, reject) => {
          AWS.config.credentials.refresh((err) => (err ? reject(err) : resolve()));
        });

        // Get latest scaling activity
        const data = await autoscaling
          .describeScalingActivities({
            AutoScalingGroupName: ASG_NAME,
            MaxRecords: 20,
          })
          .promise();

        console.log("‚úÖ Data received:", data);

        // Clear old rows
        tableBody.innerHTML = "";

        if (data.Activities && data.Activities.length > 0) {
          data.Activities.forEach((activity) => {
            const row = `
              <tr class="hover:bg-gray-700 transition fade-in">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${new Date(activity.StartTime).toLocaleString()}</td>
                <td class="px-6 py-4 text-sm text-gray-300">${activity.Description}</td>
                <td class="px-6 py-4 text-sm text-gray-300">${activity.Cause}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${
                  activity.StatusCode === "Successful" ? "text-green-400" : "text-yellow-400"
                }">${activity.StatusCode}</td>
              </tr>`;
            tableBody.innerHTML += row;
          });
        } else {
          tableBody.innerHTML =
            '<tr><td colspan="4" class="px-6 py-4 text-sm text-gray-400 text-center">No recent scaling activity found.</td></tr>';
        }

        // Update last updated timestamp
        const now = new Date().toLocaleString();
        lastUpdated.textContent = `Last updated: ${now}`;
        lastUpdated.classList.remove("hidden");

      } catch (err) {
        console.error("‚ùå Error fetching ASG activity:", err);
        tableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-sm text-red-400 text-center">Error: ${err.message}</td></tr>`;
      } finally {
        // Keep overlay visible briefly for user feedback
        setTimeout(() => {
          overlay.style.display = "none";
          loader.classList.add("hidden");
          buttonText.textContent = "üîÑ Refresh Data";
          refreshButton.disabled = false;
        }, 1000);
      }
    }

    // Attach button event
    refreshButton.addEventListener("click", fetchActivity);
  </script>
</body>
</html>
