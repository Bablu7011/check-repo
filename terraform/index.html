<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASG Activity Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 1. Load AWS SDK v2 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aws-sdk/2.1648.0/aws-sdk.min.js"></script>
    <style>
        .loader { border-top-color: #3498db; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-full text-gray-200">
    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <h1 class="text-3xl font-bold mb-6 text-white">ASG Activity Dashboard (Live)</h1>
        
        <!-- Data will be populated by the script -->
        <div class_id="asg-info" class="mb-6">
            <p class="text-lg">Fetching activity for: <strong id="asg-name" class="text-blue-400">Loading...</strong></p>
            <p class="text-sm text-gray-400">Region: <span id="asg-region">Loading...</span></p>
        </div>

        <!-- Refresh Button -->
        <button id="refreshButton" class="mb-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center justify-center">
            <span id="button-text">Refresh Data</span>
            <div id="loader" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 ml-3 hidden"></div>
        </button>

        <!-- Activity Table -->
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold mb-4 text-white">Scaling Activity</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-700">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Time</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Description</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Cause</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody id="activity-table-body" class="bg-gray-800 divide-y divide-gray-700">
                        <tr>
                            <td colspan="4" class="px-6 py-4 whitespace-nowrap text-sm text-gray-400 text-center">Loading dashboard...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // 2. These values will be replaced by Terraform
        const COGNITO_IDENTITY_POOL_ID = "__COGNITO_POOL_ID__";
        const AWS_REGION = "__AWS_REGION__";
        const ASG_NAME = "__ASG_NAME__";

        // 3. Update the UI with our variables
        document.getElementById('asg-name').textContent = ASG_NAME;
        document.getElementById('asg-region').textContent = AWS_REGION;

        // 4. Configure AWS SDK to use Cognito for credentials
        AWS.config.region = AWS_REGION;
        AWS.config.credentials = new AWS.CognitoIdentityCredentials({
            IdentityPoolId: COGNITO_IDENTITY_POOL_ID
        });

        const autoscaling = new AWS.AutoScaling();
        const refreshButton = document.getElementById('refreshButton');
        const buttonText = document.getElementById('button-text');
        const loader = document.getElementById('loader');
        const tableBody = document.getElementById('activity-table-body');

        // 5. Function to fetch and display data
        async function fetchActivity() {
            // Show loading state
            buttonText.classList.add('hidden');
            loader.classList.remove('hidden');
            refreshButton.disabled = true;
            tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-sm text-gray-400 text-center">Fetching data...</td></tr>';

            try {
                // 6. Get credentials from Cognito
                await AWS.config.credentials.getPromise();

                const params = {
                    AutoScalingGroupName: ASG_NAME,
                    MaxRecords: 20 // Get the last 20 events
                };

                const data = await autoscaling.describeScalingActivities(params).promise();
                
                if (data.Activities && data.Activities.length > 0) {
                    tableBody.innerHTML = ''; // Clear the table
                    data.Activities.forEach(activity => {
                        // --- THIS IS THE CLEAN JAVASCRIPT ---
                        // No '$$' escapes are needed anywhere.
                        const row = `
                            <tr class="hover:bg-gray-700">
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${new Date(activity.StartTime).toLocaleString()}</td>
                                <td class="px-6 py-4 text-sm text-gray-300">${activity.Description}</td>
                                <td class="px-6 py-4 text-sm text-gray-300">${activity.Cause}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${activity.StatusCode === 'Successful' ? 'text-green-400' : 'text-yellow-400'}">
                                    ${activity.StatusCode}
                                </td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });
                } else {
                    tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-sm text-gray-400 text-center">No scaling activities found.</td></tr>';
                }

            } catch (err) {
                console.error(err);
                tableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-sm text-red-400 text-center">Error: ${err.message}</td></tr>`;
            } finally {
                // Hide loading state
                buttonText.classList.remove('hidden');
                loader.classList.add('hidden');
                refreshButton.disabled = false;
            }
        }

        // 7. Add event listener and load data on page start
        refreshButton.addEventListener('click', fetchActivity);
        fetchActivity();
    </script>
</body>
</html>

